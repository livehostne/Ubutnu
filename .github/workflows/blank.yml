name: Ubuntu SSH Access

on: [push, workflow_dispatch]

jobs:
  setup-ssh:
    runs-on: ubuntu-latest

    steps:
    - name: Set up SSH Server
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server wget jq
        sudo systemctl enable ssh
        sudo systemctl start ssh
        echo "runner:P@ssw0rd" | sudo chpasswd

    - name: Install ZeroTier
      run: |
        curl -s https://install.zerotier.com | sudo bash
        sudo systemctl enable zerotier-one
        sudo systemctl start zerotier-one
        sleep 5
        sudo zerotier-cli join ${{ secrets.ZEROTIER_NETWORK_ID }}

    - name: Get ZeroTier IP
      run: |
        sleep 10
        sudo zerotier-cli listpeers
        ip=$(ip -4 -o addr show dev zt0 | awk '{split($4,a,"/");print a[1]}')
        echo "ZeroTier IP: $ip"
        
    - name: Check ZeroTier Service Logs (Optional)
      if: failure()
      run: sudo journalctl -u zerotier-one

    - name: Keep the job running
      run: sleep 1d
